name: Build Examples

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'examples/**'
      - '.github/workflows/build-examples.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'examples/**'
      - '.github/workflows/build-examples.yml'

jobs:
  build-webapp-example:
    name: Build Webapp Example
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: examples/webapp-example/package-lock.json

      - name: Install dependencies
        working-directory: examples/webapp-example
        run: npm ci

      - name: Check TypeScript types
        working-directory: examples/webapp-example
        run: npx tsc --noEmit

      - name: Lint code
        working-directory: examples/webapp-example
        run: npm run lint
        continue-on-error: true

      - name: Generate Prisma Client
        working-directory: examples/webapp-example
        run: npx prisma generate

      - name: Build project
        working-directory: examples/webapp-example
        run: npm run build

      - name: Run tests
        working-directory: examples/webapp-example
        run: npm test
        continue-on-error: true

  build-website-example:
    name: Build Website Example
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: examples/website-example/package-lock.json

      - name: Install dependencies
        working-directory: examples/website-example
        run: npm ci

      - name: Check TypeScript types
        working-directory: examples/website-example
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build project
        working-directory: examples/website-example
        run: npm run build

      - name: Check build output
        working-directory: examples/website-example
        run: |
          if [ ! -d "dist" ]; then
            echo "ERROR: Build output directory not found"
            exit 1
          fi
          echo "✓ Build output directory exists"

  test-python-cli-example:
    name: Test Python CLI Example
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        working-directory: examples/python-cli-example
        run: |
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        working-directory: examples/python-cli-example
        run: |
          poetry install

      - name: Check code formatting
        working-directory: examples/python-cli-example
        run: |
          poetry run ruff check src/
        continue-on-error: true

      - name: Type check with mypy
        working-directory: examples/python-cli-example
        run: |
          poetry run mypy src/
        continue-on-error: true

      - name: Run tests
        working-directory: examples/python-cli-example
        run: |
          poetry run pytest
        continue-on-error: true

      - name: Test CLI commands
        working-directory: examples/python-cli-example
        run: |
          poetry run todocli --version
          poetry run todocli --help
          poetry run todo --help

  status:
    name: Build Examples Status
    runs-on: ubuntu-latest
    needs: [build-webapp-example, build-website-example, test-python-cli-example]
    if: always()

    steps:
      - name: Check Build Status
        run: |
          if [ "${{ needs.build-webapp-example.result }}" != "success" ] || \
             [ "${{ needs.build-website-example.result }}" != "success" ] || \
             [ "${{ needs.test-python-cli-example.result }}" != "success" ]; then
            echo "❌ Example builds failed"
            exit 1
          fi
          echo "✅ All example builds passed"
